<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ Hàng - FruitGarden</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2ecc71; --primary-dark: #27ae60; --accent: #e74c3c; --dark-green: #145a32; --text-main: #2c3e50; --fab-color: #6f42c1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
        .navbar { background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 15px 0; }
        .nav-link { font-weight: 600; color: var(--text-main) !important; margin: 0 12px; position: relative; }
        .nav-link:hover { color: var(--primary) !important; }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 3px; bottom: -5px; left: 0; background: var(--primary); transition: width 0.3s; }
        .nav-link:hover::after { width: 100%; }

        /* Floating & Footer */
        .floating-group { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .btn-float { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .btn-up { background-color: #6c757d; opacity: 0; visibility: hidden; transform: translateY(20px); }
        .btn-up.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .btn-contact-main { background: var(--fab-color); font-size: 1.4rem; position: relative; }
        .btn-ripple { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 1px solid var(--fab-color); animation: ripple 1.5s infinite; z-index: -1; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.6); opacity: 0; } }
        .contact-popup { position: absolute; bottom: 70px; right: 0; width: 200px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .contact-item { display: flex; align-items: center; background: white; padding: 8px 15px; border-radius: 50px; text-decoration: none; color: #333; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateX(50px) scale(0.5); transition: 0.3s; }
        .icon-box { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; margin-right: 10px; }
        .zalo .icon-box { background: #0068ff; } .phone .icon-box { background: #2ecc71; }
        .contact-popup.active { pointer-events: auto; }
        .contact-popup.active .contact-item { opacity: 1; transform: translateX(0) scale(1); }
        .btn-contact-main.active { background: #dc3545; } .btn-contact-main.active .icon-close { display: block; } .btn-contact-main.active .icon-main { display: none; } .icon-close { display: none; }
        .contact-item:hover { transform: translateX(-5px) !important; }

        footer { background-color: var(--dark-green); color: #e8f5e9; position: relative; margin-top: 50px; }
        .footer-wave svg { display: block; width: calc(130% + 1.3px); height: 50px; } .footer-wave .shape-fill { fill: var(--dark-green); }
        .footer-link { color: #a5d6a7; text-decoration: none; display: block; margin-bottom: 8px; transition: 0.3s; }
        .footer-link:hover { color: white; transform: translateX(5px); }

        /* Cart Specific */
        .cart-table { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .cart-table thead { background: var(--primary); color: white; }
        .cart-table th { padding: 15px; font-weight: 600; border: none; }
        .cart-table td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #eee; }
        .cart-img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; }
        .quantity-control { display: flex; align-items: center; border: 1px solid #dee2e6; border-radius: 8px; width: fit-content; }
        .btn-qty { border: none; background: #fff; padding: 5px 10px; cursor: pointer; } .btn-qty:hover { background: #f0f0f0; }
        .input-qty { border: none; text-align: center; width: 40px; font-weight: 600; outline: none; }
        .summary-card { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #eee; position: sticky; top: 100px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .summary-total { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; font-size: 1.2rem; font-weight: 800; color: var(--accent); }
        .pointer {cursor: pointer;transition: 0.2s;}
        .pointer:hover {opacity: 0.7;transform: scale(1.1);}
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-success fs-3" href="/"><i class="fas fa-leaf me-2"></i>FruitGarden</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="/">TRANG CHỦ</a></li>
                <li class="nav-item"><a class="nav-link" href="/products">SẢN PHẨM</a></li>
                <li class="nav-item"><a class="nav-link" href="#">BLOG SỨC KHỎE</a></li>
                <li class="nav-item"><a class="nav-link" href="#">LIÊN HỆ</a></li>
            </ul>
        </div>
        <div class="d-flex align-items-center">
            <a href="/cart" class="position-relative me-3 text-dark">
                <i class="fas fa-shopping-cart fs-5"></i>
                <span th:text="${cartCount}" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle">0</span>
            </a>

            <!-- Khi đã đăng nhập -->
            <th:block th:if="${session.account != null}">
                <a href="/profile" class="me-3 text-dark">
                    <i class="fas fa-user fs-5"></i> <span th:text="${session.account.fullname}"></span>
                </a>
                <a href="/logout" class="text-danger">
                    <i class="fas fa-sign-out-alt fs-5"></i> Đăng xuất
                </a>
            </th:block>

            <!-- Khi chưa đăng nhập -->
            <th:block th:unless="${session.account != null}">
                <a href="/login" class="text-dark me-3">
                    <i class="fas fa-sign-in-alt fs-5"></i> Đăng nhập
                </a>
                <a href="/register" class="text-success">
                    <i class="fas fa-user-plus fs-5"></i> Đăng ký
                </a>
            </th:block>
        </div>
    </div>
</nav>

<!-- Nội dung giỏ hàng -->
<div class="container mt-5 pt-5">
    <h2 class="text-center mb-4">Giỏ Hàng Của Bạn</h2>

    <div th:if="${#lists.isEmpty(cartItems)}" class="alert alert-info text-center">
        Giỏ hàng của bạn đang trống! Hãy thêm sản phẩm từ trang chủ.
    </div>

    <div th:unless="${#lists.isEmpty(cartItems)}">
        <table class="table table-hover">
            <thead class="table-dark">
            <tr>
                <th>Sản Phẩm</th>
                <th>Giá</th>
                <th>Số Lượng</th>
                <th>Tổng</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}">
                <td>
                    <img th:src="${item.product.image}" th:alt="${item.product.name}" class="cart-img me-3">
                    <span th:text="${item.product.name}"></span>
                </td>
                <td th:text="${item.product.price} + ' ₫'"></td>
                <td>
                    <div class="input-group" style="width: 150px;">
                        <button class="btn btn-outline-secondary" type="button"
                                th:onclick="'updateQuantity(' + ${item.id} + ', -1)'">-</button>
                        <input type="number" th:value="${item.quantity}" class="form-control text-center" readonly>
                        <button class="btn btn-outline-secondary" type="button"
                                th:onclick="'updateQuantity(' + ${item.id} + ', 1)'">+</button>
                    </div>
                </td>
                <td th:id="'total-' + ${item.id}" th:text="${item.product.price * item.quantity} + ' ₫'"></td>
                <td>
                    <a th:href="@{/cart/remove/{id}(id=${item.id})}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                <td id="grandTotal" class="fw-bold text-success" th:text="${total} + ' ₫'"></td>
                <td></td>
            </tr>
            </tfoot>
        </table>

        <div class="text-end mt-4">
            <button onclick="checkout()" class="btn btn-success btn-lg px-5">
                <i class="fas fa-credit-card me-2"></i> Mua hàng
            </button>
        </div>
    </div>
</div>

<div class="floating-group">
    <button id="backToTopBtn" class="btn-float btn-up"><i class="fas fa-chevron-up"></i></button>
    <div class="contact-wrapper">
        <div class="contact-popup" id="contactPopup">
            <a href="#" class="contact-item zalo"><div class="icon-box"><i class="fas fa-comment-dots"></i></div><span>Chat Zalo</span></a>
            <a href="#" class="contact-item phone"><div class="icon-box"><i class="fas fa-phone-alt"></i></div><span>Gọi ngay</span></a>
        </div>
        <button id="contactToggleBtn" class="btn-float btn-contact-main"><i class="fas fa-headset icon-main"></i><i class="fas fa-times icon-close"></i><span class="btn-ripple"></span></button>
    </div>
</div>

<footer>
    <div class="footer-wave"><svg viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="shape-fill"></path></svg></div>
    <div class="container pb-5 pt-3">
        <div class="row"><div class="col-lg-4 mb-4"><h3 class="fw-bold text-white mb-3">FruitGarden<span class="text-success">.</span></h3></div></div>
        <hr class="border-secondary mt-4"><div class="text-center text-white-50 small">&copy; 2024 FruitGarden.</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Update số lượng & tổng realtime
    function updateQuantity(cartItemId, change) {
        let row = document.querySelector(`tr:has(button[onclick*='${cartItemId}'])`);
        let qtyInput = row.querySelector('input[type="number"]');
        let newQty = parseInt(qtyInput.value) + change;

        if (newQty < 1) {
            if (confirm('Xóa sản phẩm này khỏi giỏ hàng?')) {
                window.location.href = '/cart/remove/' + cartItemId;
            }
            return;
        }

        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${cartItemId}&quantity=${newQty}`
        }).then(response => {
            if (response.ok) {
                qtyInput.value = newQty;

                // Update tổng item
                let price = parseFloat(row.querySelector('td:nth-child(2)').innerText.replace(/[^0-9]/g, ''));
                let itemTotal = price * newQty;
                row.querySelector('[id^="total-"]').innerText = itemTotal.toLocaleString('vi-VN') + ' ₫';

                // Update tổng giỏ
                updateGrandTotal();

                // Update badge
                updateCartBadge();
            }
        });
    }

    // Tính tổng giỏ hàng
    function updateGrandTotal() {
        let itemTotals = document.querySelectorAll('[id^="total-"]');
        let grandTotal = 0;
        itemTotals.forEach(total => {
            grandTotal += parseFloat(total.innerText.replace(/[^0-9]/g, ''));
        });
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString('vi-VN') + ' ₫';
    }

    // Update badge realtime
    function updateCartBadge() {
        fetch('/cart/count')
            .then(response => response.text())
            .then(count => {
                document.getElementById('cartBadge').innerText = count;
            });
    }

    // Mua hàng: Xóa giỏ + cảm ơn
    function checkout() {
        if (confirm('Xác nhận mua hàng? Giỏ hàng sẽ được xóa.')) {
            fetch('/cart/clear')
                .then(response => {
                    if (response.ok) {
                        alert('Cảm ơn bạn đã mua hàng! Đơn hàng đang được xử lý.');
                        location.reload();
                    } else {
                        alert('Lỗi, vui lòng thử lại!');
                    }
                });
        }
    }

    // Load ban đầu
    window.onload = function() {
        updateCartBadge();
        updateGrandTotal();
    };

    // Floating script gốc của bạn
    const backToTopBtn = document.getElementById("backToTopBtn");
    const contactToggleBtn = document.getElementById("contactToggleBtn");
    const contactPopup = document.getElementById("contactPopup");
    window.onscroll = function() {
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
            backToTopBtn.classList.add("show");
        } else {
            backToTopBtn.classList.remove("show");
        }
    };
    backToTopBtn.addEventListener("click", function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    contactToggleBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        contactToggleBtn.classList.toggle("active");
        contactPopup.classList.toggle("active");
    });
    document.addEventListener("click", function(event) {
        if (!contactToggleBtn.contains(event.target) && !contactPopup.contains(event.target)) {
            contactToggleBtn.classList.remove("active");
            contactPopup.classList.remove("active");
        }
    });
</script>
</body>
</html>