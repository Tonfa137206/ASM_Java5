<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - FruitGarden'">Chi Tiết Sản Phẩm - FruitGarden</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #2ecc71; --accent: #e74c3c; --dark-green: #145a32; --text-main: #2c3e50; --fab-color: #6f42c1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; color: var(--text-main); }
        .navbar { background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 15px 0; }
        .nav-link { font-weight: 600; color: var(--text-main) !important; margin: 0 12px; position: relative; }
        .nav-link:hover { color: var(--primary) !important; }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 3px; bottom: -5px; left: 0; background-color: var(--primary); transition: width 0.3s; }
        .nav-link:hover::after { width: 100%; }

        footer { background-color: var(--dark-green); color: #e8f5e9; position: relative; margin-top: 50px; }
        .footer-wave svg { display: block; width: calc(130% + 1.3px); height: 50px; } .footer-wave .shape-fill { fill: var(--dark-green); }
        .social-circle { width: 40px; height: 40px; border: 1px solid #a5d6a7; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; margin-right: 10px; transition: 0.3s; }
        .social-circle:hover { background: var(--primary); border-color: var(--primary); }
        .footer-link { color: #a5d6a7; text-decoration: none; display: block; margin-bottom: 8px; transition: 0.3s; }
        .footer-link:hover { color: white; transform: translateX(5px); }

        .floating-group { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .btn-float { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .btn-up { background-color: #6c757d; opacity: 0; visibility: hidden; transform: translateY(20px); }
        .btn-up.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .btn-contact-main { background: var(--fab-color); font-size: 1.4rem; position: relative; overflow: hidden; }
        .btn-contact-main.active { background: var(--accent); }
        .btn-ripple { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.3); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; }
        @keyframes ripple { to { transform: scale(2.5); opacity: 0; } }
        .contact-popup { position: absolute; bottom: 70px; right: 0; width: 250px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 15px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: 0.3s; }
        .contact-popup.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .contact-popup a { display: flex; align-items: center; gap: 10px; color: var(--text-main); text-decoration: none; padding: 10px; border-radius: 10px; transition: 0.3s; }
        .contact-popup a:hover { background: #f0fff4; color: var(--primary); }
        .contact-popup .icon-wrap { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; }
        .icon-wrap.fb { background: #1877f2; } .icon-wrap.zalo { background: #0068ff; } .icon-wrap.phone { background: var(--primary); }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-success fs-3" href="/"><i class="fas fa-leaf me-2"></i>FruitGarden</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="/">TRANG CHỦ</a></li>
                <li class="nav-item"><a class="nav-link active" href="/products">SẢN PHẨM</a></li>
                <li class="nav-item"><a class="nav-link" href="#">BLOG SỨC KHỎE</a></li>
                <li class="nav-item"><a class="nav-link" href="#">LIÊN HỆ</a></li>
            </ul>
        </div>
        <div class="d-flex align-items-center">
            <a href="/cart" class="position-relative me-3 text-dark">
                <i class="fas fa-shopping-cart fs-5"></i>
                <span th:text="${cartCount}" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle">0</span>
            </a>

            <!-- Khi đã đăng nhập -->
            <th:block th:if="${session.account != null}">
                <a href="/profile" class="me-3 text-dark">
                    <i class="fas fa-user fs-5"></i> <span th:text="${session.account.fullname}"></span>
                </a>
                <a href="/logout" class="text-danger">
                    <i class="fas fa-sign-out-alt fs-5"></i> Đăng xuất
                </a>
            </th:block>

            <!-- Khi chưa đăng nhập -->
            <th:block th:unless="${session.account != null}">
                <a href="/login" class="text-dark me-3">
                    <i class="fas fa-sign-in-alt fs-5"></i> Đăng nhập
                </a>
                <a href="/register" class="text-success">
                    <i class="fas fa-user-plus fs-5"></i> Đăng ký
                </a>
            </th:block>
        </div>
    </div>
</nav>

<!-- Nội dung chi tiết sản phẩm -->
<div class="container mt-5 pt-5">
    <div class="row">
        <div class="col-md-6">
            <img th:src="${product.image}" th:alt="${product.name}" class="img-fluid rounded shadow">
        </div>

        <div class="col-md-6">
            <h2 class="fw-bold mb-3" th:text="${product.name}">Tên Sản Phẩm</h2>

            <div class="mb-3">
                <span class="fs-3 fw-bold text-success me-3" th:text="${product.price} + ' ₫'">Giá</span>
                <!-- Bỏ phần oldPrice để tránh lỗi (nếu sau này thêm field thì mới mở lại) -->
                <!-- <del th:if="${product.oldPrice}" class="text-muted" th:text="${product.oldPrice} + ' ₫'">Giá cũ</del> -->
            </div>

            <p class="mb-4" th:utext="${product.description}">Mô tả sản phẩm...</p>

            <div class="d-flex align-items-center mb-4">
                <span class="fw-bold me-3">Số lượng:</span>
                <div class="input-group" style="width: 150px;">
                    <button type="button" class="btn btn-outline-secondary" onclick="updateQty(-1)">-</button>
                    <input type="number" id="qtyInput" name="quantity" value="1" min="1" class="form-control text-center">
                    <button type="button" class="btn btn-outline-secondary" onclick="updateQty(1)">+</button>
                </div>
            </div>

            <form id="addToCartForm" th:action="@{/cart/add}" method="post">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" id="actionInput" name="action" value="">

                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-primary btn-lg" onclick="addToCart('cart')">
                        Thêm vào giỏ
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="addToCart('buynow')">
                        Mua ngay
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tab Mô tả & Đánh giá -->
    <div class="mt-5">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link active" href="#description">Mô tả</a></li>
            <li class="nav-item"><a class="nav-link" href="#reviews">Đánh giá</a></li>
        </ul>
        <div class="tab-content mt-3">
            <div id="description" class="tab-pane active">
                <p th:utext="${product.description}">Chi tiết mô tả...</p>
            </div>
            <div id="reviews" class="tab-pane">
                <p>Chưa có đánh giá nào.</p>
            </div>
        </div>
    </div>
</div>

<!-- Floating buttons -->
<div class="floating-group">
    <button id="backToTopBtn" class="btn-float btn-up"><i class="fas fa-arrow-up"></i></button>
    <div id="contactPopup" class="contact-popup">
        <a href="#"><div class="icon-wrap fb"><i class="fab fa-facebook-messenger"></i></div><span>Chat Facebook</span></a>
        <a href="#"><div class="icon-wrap zalo"><i class="fab fa-whatsapp"></i></div><span>Chat Zalo</span></a>
        <a href="#"><div class="icon-wrap phone"><i class="fas fa-phone-alt"></i></div><span>Gọi ngay</span></a>
    </div>
    <button id="contactToggleBtn" class="btn-float btn-contact-main"><i class="fas fa-headset icon-main"></i><i class="fas fa-times icon-close"></i><span class="btn-ripple"></span></button>
</div>

<footer>
    <div class="footer-wave"><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="shape-fill"></path></svg></div>
    <div class="container pb-5 pt-3">
        <div class="row">
            <div class="col-lg-4 mb-4"><h3 class="fw-bold text-white mb-3">FruitGarden<span class="text-success">.</span></h3></div>
            <div class="col-lg-4 mb-4 ms-auto"><h5 class="fw-bold mb-3">Liên Hệ</h5><p class="text-white-50 small">Hotline: 1900 6789</p></div>
        </div>
        <hr class="border-secondary mt-4"><div class="text-center text-white-50 small">&copy; 2024 FruitGarden.</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function changeImage(e) { document.getElementById('mainImage').src=e.src; document.querySelectorAll('.thumb-img').forEach(t=>t.classList.remove('active')); e.classList.add('active'); }
    function updateQty(c) { var i=document.getElementById('qtyInput'); var v=parseInt(i.value)+c; if(v>=1) i.value=v; }
    function addToCart(action) {
        document.getElementById('actionInput').value = action;
        document.getElementById('addToCartForm').submit();
    }

    // Floating
    const backToTopBtn=document.getElementById("backToTopBtn"), contactToggleBtn=document.getElementById("contactToggleBtn"), contactPopup=document.getElementById("contactPopup");
    window.onscroll=function(){document.body.scrollTop>300||document.documentElement.scrollTop>300?backToTopBtn.classList.add("show"):backToTopBtn.classList.remove("show")};
    backToTopBtn.addEventListener("click",function(){window.scrollTo({top:0,behavior:'smooth'})});
    contactToggleBtn.addEventListener("click",function(e){e.stopPropagation(); contactToggleBtn.classList.toggle("active"); contactPopup.classList.toggle("active")});
    document.addEventListener("click",function(e){if(!contactToggleBtn.contains(e.target)&&!contactPopup.contains(e.target)){contactToggleBtn.classList.remove("active");contactPopup.classList.remove("active")}});
    function updateQty(c) {
        var i = document.getElementById('qtyInput');
        var v = parseInt(i.value) + c;
        if (v >= 1) i.value = v;
    }

    function addToCart(action) {
        document.getElementById('actionInput').value = action;
        document.getElementById('addToCartForm').submit();
    }
    function updateQty(c) {
        var i = document.getElementById('qtyInput');
        var v = parseInt(i.value) + c;
        if (v >= 1) {
            i.value = v;  // Đã có
            // THÊM DÒNG NÀY: sync giá trị mới vào input name="quantity" (để form submit đúng)
            document.querySelector('input[name="quantity"]').value = v;
        }
    }

    function addToCart(action) {
        document.getElementById('actionInput').value = action;
        document.getElementById('addToCartForm').submit();
    }
</script>
</body>
</html>